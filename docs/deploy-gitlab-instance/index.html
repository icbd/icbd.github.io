<!DOCTYPE html>
<html>
  <head>
  <title>Deploy GitLab instance – CBD Blog – 好记性不如烂笔头,站在岸上学不会游泳</title>
      <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Story background

https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/supporting-architecture.html

Installer Scipt


  
    Setup environment variables
  
  
    Install GitLab instance, latest EE version
  
  
    Setup SMTP sender
  
  
    Setup Oauth2: Goole Workspace and GitLab.com
  


#!/bin/bash

# Base on Centos 8.2

export EXTERNAL_URL=&lt;MASK&gt;

cat &lt;&lt; VARS &gt;&gt; /etc/profile

#-- GitLab Instance
export EXTERNAL_URL="$EXTERNAL_URL"
export REGISTRY_EXTERNAL_URL="$EXTERNAL_URL:5050"

export GOOGLE_OAUTH2_APP_ID=&lt;MASK&gt;
export GOOGLE_OAUTH2_APP_SECRET=&lt;MASK&gt;

export GITLABCOM_OAUTH2_APP_ID=&lt;MASK&gt;
export GITLABCOM_OAUTH2_APP_SECRET=&lt;MASK&gt;

export GITLAB_EMAIL_FROM=&lt;MASK&gt;
export GITLAB_SMTP_DOMAIN=&lt;MASK&gt;
export GITLAB_SMTP_PASSWORD=&lt;MASK&gt;
#-- GitLab Instance
VARS
source /etc/profile


dnf install -y curl policycoreutils openssh-server perl postfix
systemctl enable sshd postfix
systemctl start sshd postfix


curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash
dnf install -y gitlab-ee


cat &lt;&lt; CONF &gt;&gt; /etc/gitlab/gitlab.rb

registry_external_url "$REGISTRY_EXTERNAL_URL"

#-- Alicloud SMTP
gitlab_rails['gitlab_email_from'] = ENV["GITLAB_EMAIL_FROM"]
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtpdm.aliyun.com"
gitlab_rails['smtp_port'] = 80
gitlab_rails['smtp_user_name'] = ENV["GITLAB_EMAIL_FROM"]
gitlab_rails['smtp_password'] = ENV["GITLAB_SMTP_PASSWORD"]
gitlab_rails['smtp_domain'] = ENV["GITLAB_SMTP_DOMAIN"]
gitlab_rails['smtp_authentication'] = "login"
#-- Alicloud SMTP

#-- OAuth2
gitlab_rails['omniauth_enabled'] = true
gitlab_rails['omniauth_allow_single_sign_on'] = ['google_oauth2']
gitlab_rails['omniauth_sync_email_from_provider'] = 'google_oauth2'
gitlab_rails['omniauth_sync_profile_from_provider'] = ['google_oauth2']
gitlab_rails['omniauth_sync_profile_attributes'] = ['name', 'email', 'location']
# gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'google_oauth2'
gitlab_rails['omniauth_block_auto_created_users'] = false
gitlab_rails['omniauth_auto_link_user'] = ['google_oauth2']
gitlab_rails['omniauth_allow_bypass_two_factor'] = ['google_oauth2']
gitlab_rails['omniauth_providers'] = [
    {
        "name" =&gt; "google_oauth2",
        "app_id" =&gt; ENV["GOOGLE_OAUTH2_APP_ID"],
        "app_secret" =&gt; ENV["GOOGLE_OAUTH2_APP_SECRET"],
        "args" =&gt; { "access_type" =&gt; "offline", "approval_prompt" =&gt; "" }
    },
    {
        "name" =&gt; "gitlab",
        "app_id" =&gt; ENV["GITLABCOM_OAUTH2_APP_ID"],
        "app_secret" =&gt; ENV["GITLABCOM_OAUTH2_APP_SECRET"],
        "args" =&gt; { "scope" =&gt; "api" }
    }
]
#-- OAuth2
CONF

gitlab-ctl reconfigure



References


  
    SMTP

    https://docs.gitlab.com/omnibus/settings/smtp.html#aliyun-direct-mail

     $ gitlab-rails c
    

     &gt; Notify.test_email('&lt;YOUR_TEST_EMAIL&gt;', 'Hello World', 'This is a test message').deliver_now
    
  
  
    OAuth

    https://docs.gitlab.com/ee/integration/omniauth.html

    https://docs.gitlab.com/ee/integration/google.html

    https://docs.gitlab.com/ee/integration/gitlab.html

    Integrating Google OAuth is to login to GitLab instance, and use mail domain to restrict login permissions.

    Integrating gitlab.com is to use facilitate the use of the repo on it, including clone and mirror .

    (Need to combine Web UI configuration.)
  


Manual Steps


  
    Reset root password and first login
  
  
    Sign-up restrictions
  


https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#disable-new-sign-ups

https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#allowlist-email-domains

https://docs.gitlab.com/ee/user/admin_area/appearance.html

Goto: Admin Area &gt; Settings &gt; General &gt; Sign-up restrictions


  Uncheck Sign-up enabled
  Uncheck Require admin approval for new sign-ups
  Check Enable email restrictions for sign ups
  Fill Allowed domains for sign-ups


Then Save changes .

Goto: Admin Area &gt; Settings &gt; General &gt; Sign-in restrictions

Enabled OAuth sign-in sources


  Uncheck GitLab.com


Then Save changes .

Goto: Admin Area &gt; Appearance


  Upload Header logo
  Fill Sign in/Sign up pages


Then Update appearance settings .


" />
    <meta property="og:description" content="Story background

https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/supporting-architecture.html

Installer Scipt


  
    Setup environment variables
  
  
    Install GitLab instance, latest EE version
  
  
    Setup SMTP sender
  
  
    Setup Oauth2: Goole Workspace and GitLab.com
  


#!/bin/bash

# Base on Centos 8.2

export EXTERNAL_URL=&lt;MASK&gt;

cat &lt;&lt; VARS &gt;&gt; /etc/profile

#-- GitLab Instance
export EXTERNAL_URL="$EXTERNAL_URL"
export REGISTRY_EXTERNAL_URL="$EXTERNAL_URL:5050"

export GOOGLE_OAUTH2_APP_ID=&lt;MASK&gt;
export GOOGLE_OAUTH2_APP_SECRET=&lt;MASK&gt;

export GITLABCOM_OAUTH2_APP_ID=&lt;MASK&gt;
export GITLABCOM_OAUTH2_APP_SECRET=&lt;MASK&gt;

export GITLAB_EMAIL_FROM=&lt;MASK&gt;
export GITLAB_SMTP_DOMAIN=&lt;MASK&gt;
export GITLAB_SMTP_PASSWORD=&lt;MASK&gt;
#-- GitLab Instance
VARS
source /etc/profile


dnf install -y curl policycoreutils openssh-server perl postfix
systemctl enable sshd postfix
systemctl start sshd postfix


curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash
dnf install -y gitlab-ee


cat &lt;&lt; CONF &gt;&gt; /etc/gitlab/gitlab.rb

registry_external_url "$REGISTRY_EXTERNAL_URL"

#-- Alicloud SMTP
gitlab_rails['gitlab_email_from'] = ENV["GITLAB_EMAIL_FROM"]
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtpdm.aliyun.com"
gitlab_rails['smtp_port'] = 80
gitlab_rails['smtp_user_name'] = ENV["GITLAB_EMAIL_FROM"]
gitlab_rails['smtp_password'] = ENV["GITLAB_SMTP_PASSWORD"]
gitlab_rails['smtp_domain'] = ENV["GITLAB_SMTP_DOMAIN"]
gitlab_rails['smtp_authentication'] = "login"
#-- Alicloud SMTP

#-- OAuth2
gitlab_rails['omniauth_enabled'] = true
gitlab_rails['omniauth_allow_single_sign_on'] = ['google_oauth2']
gitlab_rails['omniauth_sync_email_from_provider'] = 'google_oauth2'
gitlab_rails['omniauth_sync_profile_from_provider'] = ['google_oauth2']
gitlab_rails['omniauth_sync_profile_attributes'] = ['name', 'email', 'location']
# gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'google_oauth2'
gitlab_rails['omniauth_block_auto_created_users'] = false
gitlab_rails['omniauth_auto_link_user'] = ['google_oauth2']
gitlab_rails['omniauth_allow_bypass_two_factor'] = ['google_oauth2']
gitlab_rails['omniauth_providers'] = [
    {
        "name" =&gt; "google_oauth2",
        "app_id" =&gt; ENV["GOOGLE_OAUTH2_APP_ID"],
        "app_secret" =&gt; ENV["GOOGLE_OAUTH2_APP_SECRET"],
        "args" =&gt; { "access_type" =&gt; "offline", "approval_prompt" =&gt; "" }
    },
    {
        "name" =&gt; "gitlab",
        "app_id" =&gt; ENV["GITLABCOM_OAUTH2_APP_ID"],
        "app_secret" =&gt; ENV["GITLABCOM_OAUTH2_APP_SECRET"],
        "args" =&gt; { "scope" =&gt; "api" }
    }
]
#-- OAuth2
CONF

gitlab-ctl reconfigure



References


  
    SMTP

    https://docs.gitlab.com/omnibus/settings/smtp.html#aliyun-direct-mail

     $ gitlab-rails c
    

     &gt; Notify.test_email('&lt;YOUR_TEST_EMAIL&gt;', 'Hello World', 'This is a test message').deliver_now
    
  
  
    OAuth

    https://docs.gitlab.com/ee/integration/omniauth.html

    https://docs.gitlab.com/ee/integration/google.html

    https://docs.gitlab.com/ee/integration/gitlab.html

    Integrating Google OAuth is to login to GitLab instance, and use mail domain to restrict login permissions.

    Integrating gitlab.com is to use facilitate the use of the repo on it, including clone and mirror .

    (Need to combine Web UI configuration.)
  


Manual Steps


  
    Reset root password and first login
  
  
    Sign-up restrictions
  


https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#disable-new-sign-ups

https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#allowlist-email-domains

https://docs.gitlab.com/ee/user/admin_area/appearance.html

Goto: Admin Area &gt; Settings &gt; General &gt; Sign-up restrictions


  Uncheck Sign-up enabled
  Uncheck Require admin approval for new sign-ups
  Check Enable email restrictions for sign ups
  Fill Allowed domains for sign-ups


Then Save changes .

Goto: Admin Area &gt; Settings &gt; General &gt; Sign-in restrictions

Enabled OAuth sign-in sources


  Uncheck GitLab.com


Then Save changes .

Goto: Admin Area &gt; Appearance


  Upload Header logo
  Fill Sign in/Sign up pages


Then Update appearance settings .


" />
    
    <meta name="author" content="CBD Blog" />

    
    <meta property="og:title" content="Deploy GitLab instance" />
    <meta property="twitter:title" content="Deploy GitLab instance" />
    
  <link rel="stylesheet" type="text/css" href="/style.css" />
  <link rel="alternate" type="application/rss+xml" title="CBD Blog - 好记性不如烂笔头,站在岸上学不会游泳" href="/feed.xml" />
  <link rel="shortcut icon" href="/images/avatar.jpg">
<!--  <script src="https://lib.baomitu.com/gitalk/1.6.2/gitalk.min.js"></script>-->
  <script src="https://lib.baomitu.com/feather-icons/latest/feather.min.js"></script>
  <script type="text/javascript" async src="https://lib.baomitu.com/mathjax/2.7.7/MathJax.js?...">
  </script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$','$']]
      }
    });
  </script>
  <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?9dfbb5850b35a184a60c9a4a1b08d7e3";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

  <meta name="google-site-verification" content="ZqVpjmLHnwuJ0qbh4QrpcofglQe6XEjjF7X1AB7yXus" />
</head>

  <body>
    <div class="wrapper-sidebar">
  <header class="sidebar clearfix">
    <div class="site-info">
      
        <a href="/" class="site-avatar"><img src="/images/avatar.jpg" /></a>
       
      <h1 class="site-name"><a href="/">CBD Blog</a></h1>
      <p class="site-description">好记性不如烂笔头,站在岸上学不会游泳</p>
    </div>
  </header>

  <div class="navlist">
    <nav>
      
      
      <a href="/">首页</a>
      
      
      
      <a href="/archive">归档</a>
      
      
      
      <a href="/about">关于</a>
      
      
    </nav>
  </div>

  <div class="wrapper-footer-desktop">
    <footer class="footer">
      <!-- Refer to https://codepen.io/ruandre/pen/howFi -->
<ul class="svg-icon">

  
  
  

  

  
  <li><a href="mailto:wwwicbd@gmail.com" class="icon-8 email" title="Email"><svg viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg><!--[if lt IE 9]><em>Email</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://github.com/icbd" class="icon-13 github" title="GitHub"><svg viewBox="0 0 512 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg><!--[if lt IE 9]><em>GitHub</em><![endif]--></a></li>
  

  

  

  

  
  <li><a href="/feed.xml" class="icon-21 rss" title="RSS"><svg viewBox="0 0 512 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg><!--[if lt IE 9]><em>RSS</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://www.twitter.com/CbdFocus" class="icon-26 twitter" title="Twitter"><svg viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg><!--[if lt IE 9]><em>Twitter</em><![endif]--></a></li>
  

  

</ul>



<p>Copyright (c) 2020 CBD Blog</p>

    </footer>
  </div>
</div>

    
      <aside class="toc">
        <ul>
  <li><a href="#">Deploy GitLab instance</a>
    <ul>
      <li><a href="#story-background">Story background</a></li>
      <li><a href="#installer-scipt">Installer Scipt</a>
        <ul>
          <li><a href="#references">References</a></li>
        </ul>
      </li>
      <li><a href="#manual-steps">Manual Steps</a></li>
    </ul>
  </li>
</ul>
      </aside>
    

    <div id="main" role="main" class="wrapper-content">
      <div class="container">
        <article class="posts">
  <h1>Deploy GitLab instance</h1>

  <div clsss="meta">
    <span class="author">
      
    </span>

    <span class="date">
      2021-04-12
    </span>

    <ul class="tag">
      
      <li>
        <a href="https://icbd.github.io/tags#GitLab">
          GitLab
        </a>
      </li>
      
    </ul>
  </div>

  <div class="entry">
    <h2 id="story-background">Story background</h2>

<p><a href="https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/supporting-architecture.html">https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/supporting-architecture.html</a></p>

<h2 id="installer-scipt">Installer Scipt</h2>

<ol>
  <li>
    <p>Setup environment variables</p>
  </li>
  <li>
    <p>Install GitLab instance, latest EE version</p>
  </li>
  <li>
    <p>Setup SMTP sender</p>
  </li>
  <li>
    <p>Setup Oauth2: Goole Workspace and GitLab.com</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Base on Centos 8.2</span>

<span class="nb">export </span><span class="nv">EXTERNAL_URL</span><span class="o">=</span>&lt;MASK&gt;

<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">VARS</span><span class="sh"> &gt;&gt; /etc/profile

#-- GitLab Instance
export EXTERNAL_URL="</span><span class="nv">$EXTERNAL_URL</span><span class="sh">"
export REGISTRY_EXTERNAL_URL="</span><span class="nv">$EXTERNAL_URL</span><span class="sh">:5050"

export GOOGLE_OAUTH2_APP_ID=&lt;MASK&gt;
export GOOGLE_OAUTH2_APP_SECRET=&lt;MASK&gt;

export GITLABCOM_OAUTH2_APP_ID=&lt;MASK&gt;
export GITLABCOM_OAUTH2_APP_SECRET=&lt;MASK&gt;

export GITLAB_EMAIL_FROM=&lt;MASK&gt;
export GITLAB_SMTP_DOMAIN=&lt;MASK&gt;
export GITLAB_SMTP_PASSWORD=&lt;MASK&gt;
#-- GitLab Instance
</span><span class="no">VARS
</span><span class="nb">source</span> /etc/profile


dnf <span class="nb">install</span> <span class="nt">-y</span> curl policycoreutils openssh-server perl postfix
systemctl <span class="nb">enable </span>sshd postfix
systemctl start sshd postfix


curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | <span class="nb">sudo </span>bash
dnf <span class="nb">install</span> <span class="nt">-y</span> gitlab-ee


<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">CONF</span><span class="sh"> &gt;&gt; /etc/gitlab/gitlab.rb

registry_external_url "</span><span class="nv">$REGISTRY_EXTERNAL_URL</span><span class="sh">"

#-- Alicloud SMTP
gitlab_rails['gitlab_email_from'] = ENV["GITLAB_EMAIL_FROM"]
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtpdm.aliyun.com"
gitlab_rails['smtp_port'] = 80
gitlab_rails['smtp_user_name'] = ENV["GITLAB_EMAIL_FROM"]
gitlab_rails['smtp_password'] = ENV["GITLAB_SMTP_PASSWORD"]
gitlab_rails['smtp_domain'] = ENV["GITLAB_SMTP_DOMAIN"]
gitlab_rails['smtp_authentication'] = "login"
#-- Alicloud SMTP

#-- OAuth2
gitlab_rails['omniauth_enabled'] = true
gitlab_rails['omniauth_allow_single_sign_on'] = ['google_oauth2']
gitlab_rails['omniauth_sync_email_from_provider'] = 'google_oauth2'
gitlab_rails['omniauth_sync_profile_from_provider'] = ['google_oauth2']
gitlab_rails['omniauth_sync_profile_attributes'] = ['name', 'email', 'location']
# gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'google_oauth2'
gitlab_rails['omniauth_block_auto_created_users'] = false
gitlab_rails['omniauth_auto_link_user'] = ['google_oauth2']
gitlab_rails['omniauth_allow_bypass_two_factor'] = ['google_oauth2']
gitlab_rails['omniauth_providers'] = [
    {
        "name" =&gt; "google_oauth2",
        "app_id" =&gt; ENV["GOOGLE_OAUTH2_APP_ID"],
        "app_secret" =&gt; ENV["GOOGLE_OAUTH2_APP_SECRET"],
        "args" =&gt; { "access_type" =&gt; "offline", "approval_prompt" =&gt; "" }
    },
    {
        "name" =&gt; "gitlab",
        "app_id" =&gt; ENV["GITLABCOM_OAUTH2_APP_ID"],
        "app_secret" =&gt; ENV["GITLABCOM_OAUTH2_APP_SECRET"],
        "args" =&gt; { "scope" =&gt; "api" }
    }
]
#-- OAuth2
</span><span class="no">CONF

</span>gitlab-ctl reconfigure

</code></pre></div></div>

<h3 id="references">References</h3>

<ol>
  <li>
    <p>SMTP</p>

    <p><a href="https://docs.gitlab.com/omnibus/settings/smtp.html#aliyun-direct-mail">https://docs.gitlab.com/omnibus/settings/smtp.html#aliyun-direct-mail</a></p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>gitlab-rails c
</code></pre></div>    </div>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">&gt;</span> <span class="no">Notify</span><span class="p">.</span><span class="nf">test_email</span><span class="p">(</span><span class="s1">'&lt;YOUR_TEST_EMAIL&gt;'</span><span class="p">,</span> <span class="s1">'Hello World'</span><span class="p">,</span> <span class="s1">'This is a test message'</span><span class="p">).</span><span class="nf">deliver_now</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>OAuth</p>

    <p><a href="https://docs.gitlab.com/ee/integration/omniauth.html">https://docs.gitlab.com/ee/integration/omniauth.html</a></p>

    <p><a href="https://docs.gitlab.com/ee/integration/google.html">https://docs.gitlab.com/ee/integration/google.html</a></p>

    <p><a href="https://docs.gitlab.com/ee/integration/gitlab.html">https://docs.gitlab.com/ee/integration/gitlab.html</a></p>

    <p>Integrating <code class="language-plaintext highlighter-rouge">Google OAuth</code> is to login to GitLab instance, and use mail domain to restrict login permissions.</p>

    <p>Integrating <code class="language-plaintext highlighter-rouge">gitlab.com</code> is to use facilitate the use of the repo on it, including <code class="language-plaintext highlighter-rouge">clone</code> and <code class="language-plaintext highlighter-rouge">mirror</code> .</p>

    <p>(Need to combine Web UI configuration.)</p>
  </li>
</ol>

<h2 id="manual-steps">Manual Steps</h2>

<ol>
  <li>
    <p>Reset root password and first login</p>
  </li>
  <li>
    <p>Sign-up restrictions</p>
  </li>
</ol>

<p><a href="https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#disable-new-sign-ups">https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#disable-new-sign-ups</a></p>

<p><a href="https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#allowlist-email-domains">https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html#allowlist-email-domains</a></p>

<p><a href="https://docs.gitlab.com/ee/user/admin_area/appearance.html">https://docs.gitlab.com/ee/user/admin_area/appearance.html</a></p>

<p><strong><code class="language-plaintext highlighter-rouge">Goto: Admin Area &gt; Settings &gt; General &gt; Sign-up restrictions</code></strong></p>

<ul>
  <li>Uncheck <code class="language-plaintext highlighter-rouge">Sign-up enabled</code></li>
  <li>Uncheck <code class="language-plaintext highlighter-rouge">Require admin approval for new sign-ups</code></li>
  <li>Check <code class="language-plaintext highlighter-rouge">Enable email restrictions for sign ups</code></li>
  <li>Fill <code class="language-plaintext highlighter-rouge">Allowed domains for sign-ups</code></li>
</ul>

<p>Then <code class="language-plaintext highlighter-rouge">Save changes</code> .</p>

<p><strong><code class="language-plaintext highlighter-rouge">Goto: Admin Area &gt; Settings &gt; General &gt; Sign-in restrictions</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">Enabled OAuth sign-in sources</code></p>

<ul>
  <li>Uncheck <code class="language-plaintext highlighter-rouge">GitLab.com</code></li>
</ul>

<p>Then <code class="language-plaintext highlighter-rouge">Save changes</code> .</p>

<p><strong><code class="language-plaintext highlighter-rouge">Goto: Admin Area &gt; Appearance</code></strong></p>

<ul>
  <li>Upload <code class="language-plaintext highlighter-rouge">Header logo</code></li>
  <li>Fill <code class="language-plaintext highlighter-rouge">Sign in/Sign up pages</code></li>
</ul>

<p>Then <code class="language-plaintext highlighter-rouge">Update appearance settings</code> .</p>

<p><img src="/images/dev-ops-login-page.png" alt="dev-ops-login-page" /></p>

  </div>

  
  
<script src="https://utteranc.es/client.js"
        repo="icbd/blogs"
        issue-term="pathname"
        label="utteranc"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

  
</article>

<div class="pagination">
  
    <span class="prev" >
      <a href="https://icbd.github.io/gpg-introduction/">
        ← 上一篇
      </a>
    </span>
  
  
    <span class="next" >
      <a href="https://icbd.github.io/omnibus-demo/">
        下一篇 →
      </a>
    </span>
  
</div>

      </div>
    </div>
  </body>

  
  <script>
    document.getElementById("main").classList.add("withtoc");
  </script>
  

  <div class="wrapper-footer-mobile">
    <footer class="footer">
      <!-- Refer to https://codepen.io/ruandre/pen/howFi -->
<ul class="svg-icon">

  
  
  

  

  
  <li><a href="mailto:wwwicbd@gmail.com" class="icon-8 email" title="Email"><svg viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg><!--[if lt IE 9]><em>Email</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://github.com/icbd" class="icon-13 github" title="GitHub"><svg viewBox="0 0 512 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg><!--[if lt IE 9]><em>GitHub</em><![endif]--></a></li>
  

  

  

  

  
  <li><a href="/feed.xml" class="icon-21 rss" title="RSS"><svg viewBox="0 0 512 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg><!--[if lt IE 9]><em>RSS</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://www.twitter.com/CbdFocus" class="icon-26 twitter" title="Twitter"><svg viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg><!--[if lt IE 9]><em>Twitter</em><![endif]--></a></li>
  

  

</ul>



<p>Copyright (c) 2020 CBD Blog</p>

    </footer>
</html>
